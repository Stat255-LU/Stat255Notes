# Logistic Regression

### Learning Outcomes {.unnumbered}

**Conceptual Learning Outcomes**\
33. Identify situations where it is appropriate to use a logistic regression model.\
34. Calculate probabilities and odds using logistic regression.\
35. Interpret logistic regression coefficients in context.\
36. Draw conclusions about logistic regression models based on graphical representations of data.

**Computational Learning Outcomes**\
J. Perform logistic regression in R.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.height = 3, fig.width = 7, cache=TRUE)
library(ggformula)
library(moderndive)
library(gridExtra)
library(skimr)
library(Bolstad)
library(GGally)
library(Lock5Data)
library(knitr)
library(caret)
library(MASS)
library(tidyverse)
library(mosaic)
options(scipen=999)
set.seed(07302020)
```

```{r, echo=FALSE}
load("Environment.Rdata")
```

## Logistic Regression

### Modeling Binary Response

So far, we have modeled only quantitative response variables. The normal error regression model makes the assumption that the response variable is normally distributed, given the value(s) of the explanatory variables.

Now, we'll look at how to model a categorical response variable. We'll consider only situations where the response is binary (i.e. has 2 categories). Problems with categorical response variables are sometimes called **classification** problems, while problems with numeric response variables are sometimes called **regression** problems.

### Credit Card Dataset

We'll work with a dataset pertaining to 10,000 credit cards. The goal is to predict whether or not the user will default on the payment, using information on the credit card balance, user's annual income, and whether or not the user is a student. Data come from [Introduction to Statistical Learning](http://www-bcf.usc.edu/~gareth/ISL/data.html) by James, Witten, Hastie, Tibshirani.

```{r}
library(ISLR)
data(Default)
summary(Default)
```

**Default and Balance**

The plot displays each person's credit card balance on the x-axis, and whether or not they defaulted (a 0 or 1) on the y-axis.

```{r, fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
ggplot(data=Default, aes(y=default, x=balance)) + geom_jitter(alpha=0.2, height=0.05) + 
  theme_bw()
```

We see that defaults are rare when the balance is less than \$1,000, and more common for balances above \$2,000.

We'll first try fitting a linear regression model to the data to try to estimate the probability of a person defaulting on a loan, using the size of their balance as the explanatory variable.

```{r}
#convert default from yes/no to 0/1
Default <- Default |> mutate(default = as.numeric(default=="Yes")) 
```

```{r, fig.height=3, fig.width=8, message=FALSE, warning=FALSE}
ggplot(data=Default, aes(y=default, x= balance)) + geom_jitter(alpha=0.2, height=0.05)  + 
  stat_smooth(method="lm", se=FALSE)  + theme_bw()
```

There are a lot of problems with this model!

It allows the estimated probability of of default to be negative. It also assumes a linear trend that doesn't seem to fit the data very well.

A sigmoidal curve, like the one below, seems like a better model for default probabilities. This curve stays between 0 and 1, and its curved nature seems like a better fit for the data.


### Logistic Regression Model



A logistic regression model uses a sigmoidal curve like the one we saw to model default probabilities, using balance as an explanatory variable.

The model makes use of the function

$$ f(x) = \frac{e^x}{1+x^x}, $$

whose graph is shown below. This function is called an **inverse logit** function.

```{r, fig.height=3, fig.width=8, echo=FALSE}
x <- seq(from=-5, 5, by=0.01)
y <- exp(x)/ (1+exp(x))
df <- data.frame(x, y)
gf_line(data=df, y~x) + xlab("x") + ylab("y") + theme_bw()
```

Starting with our linear model $E(Y_i) = \beta_0+\beta_1x_{i1}$, we need to transform $\beta_0+\beta_1x_{i1}$ into the interval (0,1).

-   Let $\pi_i = \frac{e^{\beta_0+\beta_1x_{i1} }}{1+e^{\beta_0+\beta_1x_{i1}}}$.

-   Then $0 \leq \pi_i \leq 1$, and $\pi_i$ represents an estimate of $P(Y_i=1)$.

-   This function maps the values of $\beta_0+\beta_1x_{i1}$ into the interval (0,1).

```{r, fig.height=3, fig.width=8, echo=FALSE}
x <- seq(from=-5, 5, by=0.01)
y <- exp(x)/ (1+exp(x))
df <- data.frame(x, y)
gf_line(data=df, y~x) + xlab(expression(beta[0]+beta[1]*x[i])) + ylab(expression(pi[i])) + theme_bw()
```

The **logistic regression model** assumes that:\

-   $Y_i \in \{0,1\}$\
-   $E(Y_i) = P(Y_i=1) = \pi_i=\frac{e^{\beta_0+\beta_1x_{i1} + \ldots \beta_px_{ip}}}{1+e^{\beta_0+\beta_1x_{i1} + \ldots \beta_px_{ip}}}$ i.e. $\beta_0+\beta_1x_{i1} + \ldots \beta_px_{ip}= \text{log}\left(\frac{\pi_i}{1-\pi_i}\right).$ (This is called the logit function and can be written $\text{logit}(\pi_i)$.

Instead of assuming that the expected response is a linear function of the explanatory variables, we are assuming that it is a function of a linear function of the explanatory variables.

We fit the logistic curve to the credit card data.

```{r, fig.height=3, fig.width=8, message=FALSE, warning=FALSE}
ggplot(data=Default, aes(y=default, x= balance)) + geom_jitter(alpha=0.2, height=0.05) + 
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) +
  theme_bw()
```


To fit the logistic regression model in R, we use the function `glm`, instead of `lm`. The function is specified the same way as before, and we add `family = binomial(link = "logit")`.

```{r}
CCDefault_M <- glm(data=Default, default ~ balance, family = binomial(link = "logit"))
summary(CCDefault_M)
```

The regression equation is:

$$ P(\text{Default}) = \hat{\pi}_i = \frac{e^{-10.65+0.0055\times\text{balance}}}{1+e^{-10.65+0.0055\times\text{balance}}} $$

**Predictions**

-   For a \$1,000 balance, the estimated default probability is $\frac{e^{-10.65+0.0055(1000) }}{1+e^{-10.65+0.0055(1000)}} \approx 0.006$

-   For a \$1,500 balance, the estimated default probability is $\frac{e^{-10.65+0.0055(1500) }}{1+e^{-10.65+0.0055(1500)}} \approx 0.08$

-   For a \$2,000 balance, the estimated default probability is $\frac{e^{-10.65+0.0055(2000) }}{1+e^{-10.65+0.0055(2000)}} \approx 0.59$

We confirm these, using the `predict` command in R.

```{r}
predict(CCDefault_M, newdata=data.frame((balance=1000)), type="response")
```

```{r}
predict(CCDefault_M, newdata=data.frame((balance=1500)), type="response")
```

```{r}
predict(CCDefault_M, newdata=data.frame((balance=2000)), type="response")
```

#### Where do the b's come from? {.unnumbered}

Recall that for a quantitative response variable, the values of $b_1, b_2, \ldots, b_p$ are chosen in a way that minimizes $\displaystyle\sum_{i=1}^n \left(y_i-(\beta_0+\beta_1x_{i1}+\ldots+\beta_px_{ip})^2\right)$. Least squares does not work well in this generalized setting. Instead, the b's are calculated using a more advanced technique, known as **maximum likelihood estimation**. We won't say anything more about that topic here, but it is a prominent technique, widely used in statistic modeling. It is explored in more detail in advanced statistics courses, such as STAT 445:Mathematical Statistics.

\newpage


### Odds and Odds Ratio

For an event with probability $p$, the **odds** of the event occurring are $\frac{p}{1-p}$.

Examples: 1. The odds of a fair coin landing heads are $\frac{0.5}{1-0.5}=1$, sometimes written 1:1.

2.  The odds of a fair 6-sided die landing on a 1 are $\frac{1/6}{1-1/6}=\frac{1}{5}$, sometimes written 1:5.

In the credit card example, the odds of default are:

-   For a \$1,000 balance - odds of default are $\frac{0.00575}{1-0.00575} \approx 1:173.$

-   For a \$1,500 balance - odds of default are $\frac{0.0829}{1-0.0829 } \approx 1:11.$

-   For a \$2,000 balance - odds of default are $\frac{0.586}{1-0.586} \approx 1.414:1.$

The quantity $\frac{\frac{\pi_i}{1-\pi_i}}{\frac{\pi_j}{1-\pi_j}}$ is called the **odds ratio** and represents the odds ratio of a default for user $i$, compared to user $j$.

Example:

The default odds ratio for a \$1,000 payment, compared to a \$2,000 payment is

The odds ratio is $\frac{\frac{1}{173}}{\frac{1.414}{1}}\approx 1:244.$

The odds of a default are about 244 times larger for a \$2,000 payment than a \$1,000 payment.

### Interpretation and of $\beta_1$

Consider the odds ratio for a case $j$ with explanatory variable $x + 1$, compared to case $i$ with explanatory variable $x$.

That is $\text{log}\left(\frac{\pi_i}{1-\pi_i}\right) = \beta_0+\beta_1x$, and $\text{log}\left(\frac{\pi_j}{1-\pi_j}\right) = \beta_0+\beta_1(x+1)$.

$\text{log}\left(\frac{\frac{\pi_j}{1-\pi_j}}{\frac{\pi_i}{1-\pi_i}}\right)=\text{log}\left(\frac{\pi_j}{1-\pi_j}\right)-\text{log}\left(\frac{\pi_i}{1-\pi_i}\right)=\beta_0+\beta_1(x+1)-(\beta_0+\beta_1(x))=\beta_1.$

For every 1-unit increase in $x$ we expect the log odds of "success" to multiply by a factor of $\beta_1$.

For every 1-unit increase in $x$ we expect the odds of "success" to multiply by a factor of $e^{\beta_1}$.

**Interpretation in Credit Card Example**

$b_1=0.0055$

For each 1-dollar increase in balance on the credit card., the odds of default are estimated to multiply by $e^{0.0055}\approx1.0055$.

That is, for each additional dollar on the card balance, the odds of default are estimated to increase by 0.55%

For each increase of $d$ dollars in credit card balance, odds of default are estimated to multiply by a factor of $e^{0.0055d}$.

For every \$1,000 increase in balance, the odds of default are expected to multiply by a factor of $e^{0.0055\times 1000}\approx 244$.

Thus, the odds of default for a balance of \$2,000 are estimated to be $e^{0.0055\times 1000}\approx 244$ times as great as the odds of default for a \$1,000 balance. This matches our result when we actually calculated out the probabilities and odds.

**Hypothesis test for** $\beta_1=0$

The p-value on the "balance" line of the regression output is associated with the null hypothesis $\beta_1=0$, that is that there is no relationship between balance and the odds of defaulting on the payment.

The fact that the p-value is so small tells us that there is strong evidence of a relationship between balance and odds of default.

**Confidence Intervals for** $\beta_1$

```{r}
confint(CCDefault_M, level = 0.95)
```

We are 95% confident that for each 1 dollar increase in credit card balance, the odds of default are expected to multiply by a factor between $e^{0.00508}\approx 1.0051$ and $e^{0.00594}\approx 1.0060$.

This is a profile-likelihood interval, which you can read more about [here](https://rpubs.com/FJRubio/PLCIN).

\newpage

## Multiple Logistic Regression

### Logistic Regression Models with Multiple Explanatory Variables

We can also perform logistic regression in situations where there are multiple explanatory variables. We'll estimate probability of default, using both balance and whether or not the person is a student (a categorical variable) as explanatory variables.

```{r}
CCDefault_M2 <- glm(data=Default, default ~ balance + student, family = binomial(link = "logit"))
summary(CCDefault_M2)
```

The following graph gives an illustration of the model.

```{r}
ggplot(data=Default, aes(y=default, x= balance, color=student)) + geom_point(alpha=0.2) + stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) + theme_bw()
```

The regression equation is:

$$
P(\text{Default}) = \hat{\pi}_i = \frac{e^{-10.75+0.005738\times\text{balance}-0.71\times\text{student}_i}}{1+e^{-10.75+0.0057\times\text{balance}-0.71\times\text{student}_i}}
$$

-   For each 1 dollar increase in balance, the odds of default are estimated to multiply by a factor $e^{0.0057}\approx 1.00575$, assuming whether or not the person is a student is held constant. Thus, the estimated odds of default increase by about 0.5%, for each 1-dollar increase in balance..

-   For every \$100 increase in balance, the odds of default are estimated to multiply by $e^{0.0057\times100}\approx 1.775$, assuming whether or not the person is a student is held constant. Thus, the estimated odds of default increase by about 77.5%.

-   The odds of default for students are estimated to be $e^{-0.71} \approx 0.49$ as high for students as non-students, assuming balance amount is held constant.

**Hypothesis Tests in Multiple Logistic Regression Model**

-   Since the p-value associated with `balance` is very small, there is strong evidence of a relationship between balance and odds of default, after accounting for whether or not the person is a student.

-   Since the p-value associated with `StudentYes` is very small, there is strong evidence that students are less likely to default than nonstudents, provided the balance on the card is the same.

### Multiple Logistic Regression Model with Interaction

The previous model assumes the effect of balance on default probability is the same for students as for nonstudents. If we suspect that the effect of having a larger balance might be different for students than for nonstudents, then we could use a model with interaction between the balance and student variables.

```{r}
CCDefault_M_Int <- glm(data=Default, default ~ balance * student, family = binomial(link = "logit"))
summary(CCDefault_M_Int)
```

**Interpretations for Logistic Model with Interaction**

-   The regression equation is:

$$
P(\text{Default}) = \hat{\pi}\_i = \frac{e^{-10.87+0.0058\times\text{balance}_i-0.35\times\text{student}_i-0.0002\times\text{balance}_i\times{\text{student}_i}}}{1+e^{-10.87+0.0058\times\text{balance}_i-0.35\times\text{student}_i-0.0002\times\text{balance}_i\times{\text{student}_i}}}
$$

**Equation for Students**

$$
P(\text{Default}) = \hat{\pi}\_i = \frac{e^{-10.52+0.0056\times\text{balance}}}{1+e^{-10.52+0.0056\times\text{balance}}}
$$

Assuming a person is a student, for every \$100 increase in balance, the odds of default are expected to multiply by a factor of $e^{0.0056\times 100}=1.75$, a 75% increase.

**Equation for Non-Students**

$$
P(\text{Default}) = \hat{\pi}\_i = \frac{e^{-10.87+0.0058\times\text{balance}}}{1+e^{-10.87+0.0058\times\text{balance}}}
$$

Assuming a person is a student, for every \$100 increase in balance, the odds of default are expected to multiply by a factor of $e^{0.0058\times 100}=1.786$, a 78.6% increase.

-   Since estimate of the interaction effect is so small and the p-value on this estimate is large, it is plausible that there is no interaction at all. Thus, the simpler non-interaction model is preferable.

### Logistic Regression Key Points

-   $Y$ is a binary response variable.

-   $\pi_i$ is a function of explanatory variables $x_{i1}, \ldots x_{ip}$.

-   $E(Y_i) = \pi_i = \frac{e^{\beta_0+\beta_1x_i + \ldots\beta_px_{ip}}}{1+e^{\beta_0+\beta_1x_i + \ldots\beta_px_{ip}}}$

-   $\beta_0+\beta_1x_i + \ldots\beta_px_{ip} = \text{log}\left(\frac{\pi_i}{1-\pi_i}\right)$

-   For quantitative $x_j$, when all other explanatory variables are held constant, the odds of "success" multiply be a factor of $e^{\beta_j}$ for each 1 unit increase in $x_j$

-   For categorical $x_j$, when all other explanatory variables are held constant, the odds of "success" are $e^{\beta_j}$ times higher for category $j$ than for the "baseline category."

-   For models with interaction, we can only interpret $\beta_j$ when the values of all other explanatory variables are given (since the effect of $x_j$ depends on the other variables.)

```{r, echo=FALSE}
#save.image(file = "Environment.RData")
```
